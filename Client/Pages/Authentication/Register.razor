@page "/authentication/register"
@using System.ComponentModel.DataAnnotations

@inject IAuthenticationService _authenticationService;
@inject IToastMessageService _toastMessageService;

<div class="h-75 w-100 justify-content-center d-inline-block pt-3 ">

    <div class="container justify-content-center border border-1 pt-3" style="max-width: 600px; min-width:300px;">

        <div class="row mt-3">
            <div class="col-12 ">
                <h3 style="text-align:center;">Register</h3>
            </div>
        </div>
        @if (!IsRegisterSuccess)
        {
            <div class="row mt-3">
                <EditForm Model="@Model" OnSubmit=@TryRegister>
                    <DataAnnotationsValidator />
                    <div class="form-floating col-12 mt-3">
                        <InputText class="form-control" id="user-name" @bind-Value="Model.Username" autocomplete="username" />
                        <label for="user-name">Username</label>
                        <ValidationMessage For="()=>Model.Username"/>
                    </div>
                    <div class="form-floating col-12 mt-3">
                        <InputText type="email" class="form-control" id="user-email" @bind-Value="Model.Email" autocomplete="email" />
                        <label for="user-email">Email</label>
                        <ValidationMessage For="()=>Model.Email" />
                    </div>
                    <div class="form-floating col-12 mt-3">
                        <InputText type="text" class="form-control" id="user-phone" @bind-Value="Model.Phone" autocomplete="tel" />
                        <label for="user-phone">Phone number</label>
                        <ValidationMessage For="()=>Model.Phone" />
                    </div>
                    <div class="form-floating col-12 mt-3">
                        <InputText type="text" class="form-control" id="user-first-name" @bind-Value="Model.FirstName" autocomplete="given-name" />
                        <label for="user-first-name">FirstName</label>
                        <ValidationMessage For="()=>Model.FirstName" />
                    </div>

                    <div class="form-floating col-12 mt-3">
                        <InputText type="text" class="form-control" id="user-last-name" @bind-Value="Model.LastName" autocomplete="family-name" />
                        <label for="user-last-name">LastName</label>
                        <ValidationMessage For="()=>Model.LastName" />
                    </div>
                    <div class="form-floating col-12 mt-3">
                        <InputText type="password" class="form-control" id="password" @bind-Value="Model.Password" autocomplete="new-password" />
                        <label for="password">Password</label>
                        <ValidationMessage For="()=>Model.Password" />
                    </div>
                    <div class="form-floating col-12 mt-3">
                        <InputText type="password" class="form-control" id="confirm-password" @bind-Value="Model.ConfirmPassword" autocomplete="new-password" />
                        <label for="confirm-password">Confirm Password</label>
                        <ValidationMessage For="()=>Model.ConfirmPassword" />
                    </div>
                    <div class="col-12 text-center my-2">
                        <button class="btn btn-primary px-5" type="submit">Register</button>
                    </div>
                </EditForm>
            </div>
        }
        else
        {
            <div class="row mt-3">
                <EditForm Model="@VerificationModel" OnSubmit=@TryVerify>
                    <DataAnnotationsValidator />
                    <div class="form-floating col-12">
                        <InputText type="text" class="form-control" id="code" @bind-Value="@VerificationModel.Code" />
                        <label for="code">Verification code for @VerificationModel.Email</label>
                        <ValidationMessage For="()=>VerificationModel.Code" />
                    </div>
                    <div class="col-12 text-center my-2">
                        <button class="btn btn-primary px-5" type="submit">Verification</button>
                    </div>
                </EditForm>
            </div>
        }
    </div>
</div>



@code {
    private RegisterContract Model { get; set; } = new();
    private VerificationContract VerificationModel { get; set; } = new();

    private bool IsRegisterSuccess { get; set; } = false;

    private async Task TryRegister(EditContext editContext)
    {
        if (!editContext.Validate())
        {
            _toastMessageService.AddErrorMessage(Error.Validation("Some fields are not valid"));
            return;
        }
        var result = await _authenticationService.Register(Model);
        IsRegisterSuccess = result.IsSuccess;
        if (!result.IsSuccess)
        {
            _toastMessageService.AddErrorMessage(result.Errors);
        }
        else
        {
            _toastMessageService.AddSuccessMessage("Sign In was success, input send code for confirm your credentials");
            VerificationModel.Email = Model.Email;
        }
    }

    private async Task TryVerify(EditContext editContext)
    {
        if (!editContext.Validate())
        {
            _toastMessageService.AddErrorMessage(Error.Validation("Some fields are not valid"));
            return;
        }
        var result = await _authenticationService.Verify(VerificationModel);
        if (!result.IsSuccess)
        {
            _toastMessageService.AddErrorMessage(result.Errors);
        }
        else
        {
            _toastMessageService.AddSuccessMessage("Code confirmed successful");
        }
    }
}
